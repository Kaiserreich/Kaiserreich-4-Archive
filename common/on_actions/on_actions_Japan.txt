on_actions = {
	#ROOT is winner #FROM gets annexed - For civil wars on_civil_war_end is also fired
	on_annex = {
		effect = {
			FROM = {
				JAP_remove_from_economic_sphere = yes
				remove_from_tech_sharing_group = japan_research
			}

			if = {
				limit = {
					FROM = { has_country_flag = has_offsite_mils_from_JAP }
					country_exists = JAP
				}
				FROM = {
					add_offsite_building = { type = arms_factory level = -2 }
					clr_country_flag = has_offsite_mils_from_JAP
				}
				JAP = {
					every_owned_state = {
						limit = { has_variable = JAP_mils_to_china_state }
						add_building_construction = {
							type = arms_factory
							level = var:JAP_mils_to_china_state
							instant_build = yes
						}
						clear_variable = JAP_mils_to_china_state
					}
				}
			}

			if = {
				limit = { FROM = { tag = JAP } }
				if = {
					limit = {
						LEC = {
							exists = yes
							is_subject = no
						}
					}
					LEC = {
						country_event = { id = lec.130 hours = 12 }
					}
				}
				JAP_fading_sun = yes
				FNG_break_with_japan = yes
				524 = {
					if = {
						limit = {
							NOT = { is_owned_by = JAP }
							has_dynamic_modifier = { modifier = JAP_model_colony }
						}
						remove_dynamic_modifier = { modifier = JAP_model_colony }
					}
				}
				525 = {
					if = {
						limit = {
							NOT = { is_owned_by = JAP }
							has_dynamic_modifier = { modifier = JAP_korean_military_administration }
						}
						remove_dynamic_modifier = { modifier = JAP_korean_military_administration }
					}
				}
				527 = {
					if = {
						limit = {
							NOT = { is_owned_by = JAP }
							has_dynamic_modifier = { modifier = JAP_korean_military_administration }
						}
						remove_dynamic_modifier = { modifier = JAP_korean_military_administration }
					}
				}
			}
		}
	}

	# ROOT is capitulated country, FROM is winner
	on_capitulation_immediate = {
		effect = {
			if = {
				limit = {
					original_tag = JAP
					is_faction_leader = yes
					NOT = { has_global_flag = JAP_Fading_Sun }
				}
				JAP_capitulation_effect = yes
			}
			if = {
				limit = {
					tag = JAP
					has_war_with = GER
				}
				log = "KR_Event_Logging;GEA WINS GEA-JAP WAR;[GetDateText]"
			}
		}
	}

	#FROM is war target
	on_declare_war = {
		effect = {
			# removing from Japanese economic sphere
			if = {
				limit = {
					FROM = { tag = JAP }
					has_country_flag = JAP_economic_sphere_member
				}
				ROOT = { country_event = japfor.404 }
			}
			if = {
				limit = {
					tag = JAP
					FROM = { has_country_flag = JAP_economic_sphere_member }
				}
				FROM = { country_event = japfor.404 }
			}

			# removing Japanese extra mils
			if = {
				limit = {
					FROM = { has_country_flag = has_offsite_mils_from_JAP }
					ROOT = { tag = JAP }
				}
				FROM = {
					add_offsite_building = { type = arms_factory level = -2 }
					clr_country_flag = has_offsite_mils_from_JAP
				}
				ROOT = {
					every_owned_state = {
						limit = { has_variable = JAP_mils_to_china_state }
						add_building_construction = {
							type = arms_factory
							level = var:JAP_mils_to_china_state
							instant_build = yes
						}
						clear_variable = JAP_mils_to_china_state
					}
				}
			}
			if = {
				limit = {
					ROOT = { has_country_flag = has_offsite_mils_from_JAP }
					FROM = { tag = JAP }
				}
				ROOT = {
					add_offsite_building = { type = arms_factory level = -2 }
					clr_country_flag = has_offsite_mils_from_JAP
				}
				FROM = {
					every_owned_state = {
						limit = { has_variable = JAP_mils_to_china_state }
						add_building_construction = {
							type = arms_factory
							level = var:JAP_mils_to_china_state
							instant_build = yes
						}
						clear_variable = JAP_mils_to_china_state
					}
				}
			}
			if = {
				limit = {
					ROOT = { tag = JAP }
					FROM = { tag = GEA }
				}
				log = "KR_Event_Logging;GEA-JAP WAR START;[GetDateText]"
			}
		}
	}

	on_ruling_party_change = {
		effect = {
			if = {
				limit = {
					has_country_flag = JAP_economic_sphere_member
					has_socialist_government = yes
				}
				country_event = japfor.404
			}
			if = {
				limit = {
					tag = FNG
					is_subject_of = JAP
				}

				# Readd Concordia Advisors
				FNG_sun_qichang = { set_nationality = FNG }
				FNG_ding_jianxiu = { set_nationality = FNG }
				FNG_ruan_zhenduo = { set_nationality = FNG }
				FNG_yang_yuting = { set_nationality = FNG }

				# Remove Zhang Advisors
				FNG_wang_yintai = { retire = yes }
				FNG_lu_ronghuan = { retire = yes }
				FNG_yuan_jinkai = { retire = yes }
				FNG_wu_junsheng = { retire = yes }
				FNG_zhang_zuoxiang = { retire = yes }
				FNG_zhang_zuolin = { retire = yes }
				FNG_zhang_xueliang = { retire = yes }

				#uncomplete unification by negotiation
				clr_global_flag = FNG_conference_success
				set_global_flag = FNG_conference_failed
				clr_country_flag = FNG_conference_song_support
				clr_country_flag = FNG_conference_federalist_support
				unlock_national_focus = FNG_Begin_the_War_of_National_Reclamation
				unlock_national_focus = FNG_From_Beijing_to_the_Begonia_Leaf
				if = {
					limit = { has_completed_focus = FNG_Unification_through_Negotiation }
					unlock_national_focus = FNG_Unification_through_Subjugation
					uncomplete_national_focus = {
						focus = FNG_Unification_through_Negotiation
						uncomplete_children = yes
					}
				}
				else_if = {
					limit = { NOT = { has_completed_focus = FNG_Unification_through_Subjugation } }
					complete_national_focus = FNG_Unification_through_Subjugation
				}
				unlock_national_focus = FNG_The_Question_of_the_Presidency
			}
			if = {
				limit = {
					is_co_prosperity_candidate = yes
					is_subject_of = JAP
				}
				add_to_array = { global.JAP_possible_allies_array = ROOT }
				set_variable = { ROOT.japanese_economic_influence = 0 }
			}
		}
	}

	on_new_term_election = {
		effect = {
			if = {
				limit = { tag = JAP }
				country_event = japdom.3	#1936
				country_event = japdom.54	#1940
				country_event = japdom.55	#1944
			}
		}
	}

	#FROM is country getting invited.
	on_offer_join_faction = {
		effect = {
			# removing from Japan's economic sphere
			if = {
				limit = {
					NOT = { tag = JAP }
					JAP = { has_completed_focus = JAP_osaka_conference }
					FROM = { has_country_flag = JAP_economic_sphere_member }
				}
				JAP = { country_event = japfor.411 }
			}

			# remove BRM's German guarantee
			if = {
				limit = {
					FROM = {
						tag = BRM
						has_guarantor = yes
					}
				}
				every_other_country = {
					limit = { has_guaranteed = BRM }
					diplomatic_relation = {
						country = BRM
						relation = guarantee
						active = no
					}
				}
			}

			if = {
				limit = {
					FROM = { has_country_flag = JAP_economic_sphere_member }
					NOT = {
						tag = JAP
						tag = GER #always hostile
						tag = MAF
						tag = GEA
						tag = BAT
						tag = RUS
						tag = FRA
						tag = ENG
						tag = CSA
						tag = SRI
						tag = SWF
						tag = SOV
						tag = FOP
						tag = HND
						tag = USA #can't join
						tag = TEX
						tag = NEE
						tag = RAJ
						tag = DEI
						tag = INS #handled by tag content
					}
					OR = {
						tag = FNG
						original_tag = GXC
						tag = SQI
						is_chinese_tag = no #others can't join
					}
				}
				activate_targeted_decision = { target = JAP decision = JAP_join_rikagaku_kenkyusho }
				activate_targeted_decision = { target = JAP decision = JAP_join_rikagaku_kenkyusho }
				activate_targeted_decision = { target = JAP decision = JAP_withdraw_from_alliance }
				activate_targeted_decision = { target = JAP decision = JAP_withdraw_from_sphere }
			}
		}
	}

	#ROOT is winner #FROM is loser
	on_peaceconference_ended = {
		effect = {
			if = {
				limit = { FROM = { original_tag = JAP } }
				524 = {
					if = {
						limit = {
							NOT = { is_owned_by = JAP }
							has_dynamic_modifier = { modifier = JAP_model_colony }
						}
						remove_dynamic_modifier = { modifier = JAP_model_colony }
					}
				}
				525 = {
					if = {
						limit = {
							NOT = { is_owned_by = JAP }
							has_dynamic_modifier = { modifier = JAP_korean_military_administration }
						}
						remove_dynamic_modifier = { modifier = JAP_korean_military_administration }
					}
				}
				527 = {
					if = {
						limit = {
							NOT = { is_owned_by = JAP }
							has_dynamic_modifier = { modifier = JAP_korean_military_administration }
						}
						remove_dynamic_modifier = { modifier = JAP_korean_military_administration }
					}
				}
			}
			else_if = {
				limit = { original_tag = JAP }
				525 = {
					if = {
						limit = {
							is_owned_by = JAP
							NOT = { has_dynamic_modifier = { modifier = JAP_korean_military_administration } }
						}
						add_dynamic_modifier = { modifier = JAP_korean_military_administration }
					}
				}
				527 = {
					if = {
						limit = {
							is_owned_by = JAP
							NOT = { has_dynamic_modifier = { modifier = JAP_korean_military_administration } }
						}
						add_dynamic_modifier = { modifier = JAP_korean_military_administration }
					}
				}
			}
		}
	}

	#ROOT is new controller #FROM is old controller #FROM.FROM is state ID
	on_state_control_changed = {
		effect = {
			# Add/remove Japanese modifiers
			FROM.FROM = {
				if = {
					limit = {
						is_core_of = KOR
						NOT = { is_owned_by = JAP }
						has_dynamic_modifier = { modifier = JAP_korean_military_administration }
					}
					remove_dynamic_modifier = { modifier = JAP_korean_military_administration }
				}
				else_if = {
					limit = {
						state = 524
						NOT = { is_owned_by = JAP }
						has_dynamic_modifier = { modifier = JAP_model_colony }
					}
					remove_dynamic_modifier = { modifier = JAP_model_colony }
				}
			}
		}
	}
	# Japan - China war status
	on_monthly_JAP = {
		effect = {
			if = {
				limit = { date > 1939.1.1 }
				JAP_log_war_progress_in_china = yes
			}
		}
	}

	on_war_relation_added = {
		effect = {
			if = {
				limit = {
					original_tag = JAP
					is_subject = no
					FROM = {
						is_american_tag = yes
						is_subject = no
					}
					has_global_flag = USA_civil_war_over_flag
				}
				news_event = { id = japfor.470 hours = 1 }
			}
			else_if = {
				limit = {
					is_american_tag = yes
					is_subject = no
					FROM = {
						original_tag = JAP
						is_subject = no
					}
					has_global_flag = USA_civil_war_over_flag
				}
				news_event = { id = japfor.470 hours = 1 }
			}
		}
	}
}
